package vulnerability

import (
	"fmt"
	"github.com/whereiskurt/tio-cli/internal/pkg/tio"
	"github.com/whereiskurt/tio-cli/internal/pkg/tio/dao"
	"strconv"
	"time"
)

type Scan struct {
	Config *tio.VulnerabilityConfig

	Debug func(string)
	Info  func(string)
	Warn  func(string)
	Error func(string)

	Debugf func(string, ...interface{})
	Infof  func(string, ...interface{})
	Warnf  func(string, ...interface{})
	Errorf func(string, ...interface{})
}

func NewScan(config *tio.VulnerabilityConfig) *Scan {
	s := new(Scan)
	s.Config = config
	//Convenience functions
	s.Debug = config.Base.Logger.Debug
	s.Debugf = config.Base.Logger.Debugf
	s.Info = config.Base.Logger.Info
	s.Infof = config.Base.Logger.Infof
	s.Warn = config.Base.Logger.Warn
	s.Warnf = config.Base.Logger.Warnf
	s.Error = config.Base.Logger.Error
	s.Errorf = config.Base.Logger.Errorf
	return s
}

func (s *Scan) Execute() error {
	s.Info("Executing vulnerability.scan.Execute()")

	var previousOffset, _ = strconv.Atoi(s.Config.Previous)

	trans := dao.NewTranslator(s.Config)

	s.Debugf("Configuration used:%+v", s.Config.Base.GetStatistics())

	scans, err := trans.GetScans()
	if err != nil {
		s.Errorf("Failed to GetScans(): %s", err)
		return err
	}

	for _, scan := range scans {
		var reqStartTime = time.Now() //Start the clock!

		s.Debugf("Looking up scan id:%+v", scan.ScanId)
		d, _ := trans.GetScanDetail(scan.ScanId, previousOffset)
		if d != nil {
		}
		var reqEndTime = time.Now() //Stop the clock!
		var reqDuration = fmt.Sprintf("%v", reqEndTime.Sub(reqStartTime))
		s.Debugf("Found scan id %+v took %v", scan.ScanId, reqDuration)

	}

	s.Infof("Stats: tenable.portal:%+v", s.Config.Base.GetStatistics()["tenable.portal"])
	s.Infof("Stats: tio.cache:%+v", s.Config.Base.GetStatistics()["tio.cache"])
	s.Infof("Stats: dao.translator:%+v", s.Config.Base.GetStatistics()["dao.translator"])

	return nil
}
