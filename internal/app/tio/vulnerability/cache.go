package vulnerability

import (
	"strconv"
	"strings"
	"sync"

	"github.com/whereiskurt/tio-cli/internal/pkg/tio"
	"github.com/whereiskurt/tio-cli/internal/pkg/tio/api/tenable"
	"github.com/whereiskurt/tio-cli/internal/pkg/tio/cache"
	"github.com/whereiskurt/tio-cli/internal/pkg/tio/dao"
	"github.com/whereiskurt/tio-cli/internal/pkg/tio/ui"
)

type Cache struct {
	Config            *tio.VulnerabilityConfig
	Workers           *sync.WaitGroup
	ConcurrentWorkers int
}

func NewCache(config *tio.VulnerabilityConfig) (h *Cache) {
	h = new(Cache)
	h.Config = config

	h.Workers = new(sync.WaitGroup)
	h.ConcurrentWorkers, _ = strconv.Atoi(config.Base.ConcurrentWorkers)

	return h
}

func (h *Cache) Execute() error {
	trans := dao.NewTranslator(h.Config)

	if h.Config.ShouldAnon == true {
		trans.Anonymizer = tenable.NewAnonymizer(h.Config)
	}

	if h.Config.SyncMode == true {
		portal := cache.NewPortalCache(h.Config.Base)
		filename, _ := portal.PortalCacheFilename("/scans")
		trans.Errorf("--syncmode and should delete: %#v", filename)
		for _, scanId := range strings.Split(h.Config.ScanId, ",") {
			filename, _ := portal.PortalCacheFilename("/scans/" + scanId)
			trans.Errorf("--syncmode and should delete: %#v", filename)
		}
	}

	cli := ui.NewCommandLineInterface(h.Config.Base)

	ch := make(chan dao.ScanHistory, h.ConcurrentWorkers)

	go trans.GoGetHostDetails(ch, h.ConcurrentWorkers)

	for rec := range ch {
		current := &rec.ScanHistoryDetails[0]
		keys := trans.SortScanHostKeys(current)
		if len(rec.ScanHistoryDetails) > 0 {
			cli.DrawHosts(rec.ScanHistoryDetails[0], keys)
		}
	}

	return nil
}
