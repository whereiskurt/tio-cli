package vulnerability

import (
  "fmt"
  "os"
  "strconv"
  "strings"
  "sync"
	"time"
  "github.com/briandowns/spinner"
  "github.com/whereiskurt/tio-cli/internal/pkg/tio"
	"github.com/whereiskurt/tio-cli/internal/pkg/tio/api/tenable"
	"github.com/whereiskurt/tio-cli/internal/pkg/tio/cache"
	"github.com/whereiskurt/tio-cli/internal/pkg/tio/dao"
	"github.com/whereiskurt/tio-cli/internal/pkg/tio/ui"
)

type Cache struct {
	Config            *tio.VulnerabilityConfig
	Workers           *sync.WaitGroup
	ConcurrentWorkers int
}

func NewCache(config *tio.VulnerabilityConfig) (h *Cache) {
	h = new(Cache)
	h.Config = config

	h.Workers = new(sync.WaitGroup)
	h.ConcurrentWorkers, _ = strconv.Atoi(config.Base.ConcurrentWorkers)

	return h
}

func (h *Cache) Execute() error {
	trans := dao.NewTranslator(h.Config)
  cli := ui.NewCommandLineInterface(h.Config.Base)

  h.OutputBanner(trans, cli)

  syncMode := h.Config.SyncMode
  shouldAnon := h.Config.ShouldAnon

  if shouldAnon == true {
    trans.Anonymizer = tenable.NewAnonymizer(h.Config)
  }
  
  //Remove ScanList and ScanDetails for scans
  if syncMode == true {
    portal := cache.NewPortalCache(h.Config.Base)
    filename, _ := portal.PortalCacheFilename("/scans")
    cli.Println(fmt.Sprintf("DELETING the cached scan list file '%s' ...", filename))
    os.Remove(filename)
    for _, scanId := range strings.Split(h.Config.ScanId, ",") {
      filename, _ := portal.PortalCacheFilename("/scans/" + scanId)
      cli.Println(fmt.Sprintf("DELETING the cached scan list for specific scanId '%s' filename '%s' ...", filename))
      os.Remove(filename)
    }
    //TODO: Clear out folders/files based on these params too!
    // for _,historyId := range strings.Split(h.Config.PluginId, ",") { }
    // for _,pluginID := range strings.Split(h.Config.PluginId, ",") { }
  }


  ch := make(chan dao.ScanHistory, h.ConcurrentWorkers)

  go trans.GoGetHostDetails(ch, h.ConcurrentWorkers)

  scans, _ := trans.GetScans()

  scanCount := len(scans)
  depth, _ := strconv.Atoi(h.Config.Depth)
  totScans := depth * scanCount

  s := spinner.New(spinner.CharSets[9], 100*time.Millisecond)  // Build our new spinner
  s.Writer = h.Config.Base.Output

  s.Prefix = fmt.Sprintf("Fetching Total Scans: '%v' ", totScans) 
  s.Start()
  i := 1
  for rec := range ch { 
    s.FinalMSG = fmt.Sprintf("Done! '%v' (id:%v) \n", rec.Scan.Name, rec.Scan.ScanId)
    s.Stop()
    trans.Debug(fmt.Sprintf("'%d / %d': Scan '%s' cached with hosts.", i, len(scans), rec.Scan.ScanId))
    s.Prefix = fmt.Sprintf("Fetching HOSTS for scan '%v' (id:%v) ", rec.Scan.Name, rec.Scan.ScanId)
    s.FinalMSG = fmt.Sprintf("Done! '%v' (id:%v) \n", rec.Scan.Name, rec.Scan.ScanId)

    s.Start()
    i = i + 1
  }
  s.Stop()

  trans.Debugf(fmt.Sprintf("Stats: tenable.portal:%#v", trans.PortalCache.Portal.Stats.GetCounts()))
  trans.Debugf(fmt.Sprintf("Stats: tio.cache:%#v", trans.PortalCache.Stats.GetCounts()))
  trans.Debugf(fmt.Sprintf("Stats: dao.translator:%#v", trans.Stats.GetCounts()))


  h.OutputFooter(trans, cli)

  return nil
}

func (h *Cache) OutputBanner(trans *dao.Translator, cli *ui.CommandLineInterface)  {
  dts := time.Now().UTC().Format(time.RFC3339)
  scans, _ := trans.GetScans()
  
  scanCount := len(scans)
  depth, _ := strconv.Atoi(h.Config.Depth)
  totScans := depth * scanCount
  cli.Println(
"                _ \n" +
"               | |\n" +
"  ___ __ _  ___| |__   ___\n" +
" / __/ _` |/ __| '_ \\ / _ \\\n" +
"| (_| (_| | (__| | | |  __/\n" +
" \\___\\__,_|\\___|_|_|_|\\___|\n" +
"---------------------------------tio-cli v0.5\n" +

`Execution: ` + fmt.Sprintf("%v", dts) + `

Will attempt to locally cache '` + fmt.Sprintf("%v",scanCount) + `' scans from Tenable.IO with a history depth of '` + fmt.Sprintf("%v", depth) + `' (` + fmt.Sprintf("%v", totScans) + `)`)

}

func (h *Cache) OutputFooter(trans *dao.Translator, cli *ui.CommandLineInterface)  {
  stats := trans.Stats.GetCounts()
  portalStats :=  trans.PortalCache.Stats.GetCounts()

  scans, _ := trans.GetScans()

  scanCount := len(scans)
  depth, _ := strconv.Atoi(h.Config.Depth)
  totScans := depth * scanCount

  cli.Println(
"\n"+
"Total Scans SUCCESS: " + fmt.Sprintf("%v (%v x %v == %v)", stats["tio.dao.GetScan.CallCount"],stats["tio.dao.GetScan.CallCount"], depth, totScans ) + "\n" + 
"Total Hosts SUCCESS: " + fmt.Sprintf("%v", stats["tio.dao.GetHostDetail.CallCount"]) +  "\n" +
"Total Hosts FAILED: " + fmt.Sprintf("%v", stats["tio.dao.GetHostDetail.ErrorBadData"]) +  "\n" +
"\n"+
"Total DISK CACHE: " + fmt.Sprintf("%v", portalStats["tio.cache.HIT"]) + " HITS / " + fmt.Sprintf("%v", portalStats["tio.cache.MISS"]) + " MISSES\n" )

// Total API GET calls made to Tenable.IO: trans.PortalCache.Portal.Stats['tio.api.GET.Success']
//       API calls 'bad data': trans.PortalCache.Stats['tio.dao.GetHostDetail.ErrorBadData']

// `)

}