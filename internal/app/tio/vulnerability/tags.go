package vulnerability

import (
	"errors"
	"fmt"
	"strconv"
	"sync"

	"github.com/whereiskurt/tio-cli/internal/pkg/tio"
	"github.com/whereiskurt/tio-cli/internal/pkg/tio/dao"
	"github.com/whereiskurt/tio-cli/internal/pkg/tio/ui"
)

type Tags struct {
	Config            *tio.VulnerabilityConfig
	Workers           *sync.WaitGroup
	ConcurrentWorkers int
}

func NewTags(config *tio.VulnerabilityConfig) *Tags {
	s := new(Tags)
	s.Config = config

	s.Workers = new(sync.WaitGroup)
	s.ConcurrentWorkers, _ = strconv.Atoi(config.Base.ConcurrentWorkers)

	return s
}

func (tagsCmd *Tags) Execute() error {

	tagCategory := tagsCmd.Config.TagCategory
	tagValue := tagsCmd.Config.TagValue

	if tagsCmd.Config.Create == true {
		tagsCmd.CreateTag(tagCategory, tagValue)
		return nil
	} else if tagsCmd.Config.Delete == true {
		tagsCmd.DeleteTag(tagCategory, tagValue)
		return nil
	}


	if !(tagsCmd.Config.Tag || tagsCmd.Config.Untag) {
		if	tagsCmd.Config.SearchView == true {
			return nil
		} else if	tagsCmd.Config.ListView == true {
			return nil
		}
	}

	//Tag a specific AssetUUD if we have it.
	if tagsCmd.Config.AssetUUID != "" {
		assetUUID := tagsCmd.Config.AssetUUID
		if tagsCmd.Config.Tag == true {
			tagsCmd.Tag(assetUUID, tagCategory, tagValue)

		} else if	tagsCmd.Config.Untag == true {
			tagsCmd.Untag(assetUUID, tagCategory, tagValue)
		
		}
		return nil
	}

	var trans = dao.NewTranslator(tagsCmd.Config)
	trans.Info("Executing tio.vulnerability.tags.Execute()")

	//Use the scan history and scanid,hostid,pluginid,etc.
	ch := make(chan dao.ScanHistory, 2)

	go trans.GoGetHostDetails(ch, 6)

	for rec := range ch {
		if len(rec.ScanHistoryDetails) == 0 {
			continue
		}
		scan := rec.ScanHistoryDetails[0]
		hosts := scan.Host
		for _, h := range hosts {
			assetUUID := h.Asset.UUID

			if tagsCmd.Config.Tag == true {
				tagsCmd.Tag(assetUUID, tagCategory, tagValue)

			} else if	tagsCmd.Config.Untag == true {
				tagsCmd.Untag(assetUUID, tagCategory, tagValue)

			}
		}
	}
	return nil
}

func (tagsCmd *Tags) CreateTag(tagCategory string, tagValue string) (err error){
	var trans = dao.NewTranslator(tagsCmd.Config)

	categories, err := trans.GetTagCategories()

	if err != nil {
		trans.Errorf("Error: %s", err)
		return err
	}

	if tagCategory == "" {
		err = errors.New("Must provide a category name.") 
		trans.Errorf("%s",err)
		return err
	}

	var categoryUUID string = ""
	for _,v := range categories.Categories {
		if tagCategory == v.Name {
			categoryUUID = v.UUID
			break
		}
	}

	if categoryUUID == ""  { 
		trans.Infof("Creating category '%s' ... ", tagCategory)
		categoryUUID, err = trans.CreateTagCategory(tagCategory)
		if err != nil { 
			trans.Errorf("Error: %s", err)
			return err
		}
	}

	if tagValue != ""  { 
		trans.Infof("Creating category:value '%s' for category '%s' [%s]", tagValue, tagCategory, categoryUUID)
		trans.CreateTagValue(categoryUUID, tagCategory, tagValue)
	}

	return err
}

func (tagsCmd *Tags) DeleteTag(tagCategory string, tagValue string) (err error){
	var trans = dao.NewTranslator(tagsCmd.Config)

	if tagCategory == "" || tagValue == "" {
			err := errors.New("Error: Must specify a category and value - ie. won't delete category ONLY category values.")
			trans.Errorf("%s",err)
			return err
	}

	//DELETE:https://cloud.tenable.com/tags/categories/39d2705b-9c06-4c1e-9f03-98c1769705de
	//DELETE:https://cloud.tenable.com/tags/values/25214874-a953-4ef2-851d-f773357ec490
	
	return err
}

func (tagsCmd *Tags) Tag(assetUUID string, tagCategory string, tagValue string) {
	var trans = dao.NewTranslator(tagsCmd.Config)
	var cli = ui.NewCommandLineInterface(tagsCmd.Config.Base)

	trans.TagByAssetUUID(assetUUID, tagCategory, tagValue)
	cli.Println(fmt.Sprintf("Tagging AssetUUID: %s with Category:%s Value:%s\n", assetUUID, tagCategory, tagValue))

	return
}
func (tagsCmd *Tags) Untag(assetUUID string, tagCategory string, tagValue string) {
	var trans = dao.NewTranslator(tagsCmd.Config)
	var cli = ui.NewCommandLineInterface(tagsCmd.Config.Base)

	trans.UntagByAssetUUID(assetUUID, tagCategory, tagValue)
	cli.Println(fmt.Sprintf("Untagging AssetUUID: %s with Category:%s Value:%s\n", assetUUID, tagCategory, tagValue))

	return
}

//  tio-cli asset --list --scanId=67
//
//  tio-cli tags --list
//  tio-cli tags --search --category "addenda-agents" --value "testagkph"
//
//  tio-cli tags --tag --category "addenda-agents" --value "testagkph" --scanId=67
//  tio-cli tags --tag --category "addenda-agents" --value "testagkph" --assetUUID=ae33der-e39c91a-cbf313
//  tio-cli tags --untag --category "addenda-agents" --value "testagkph" --scanId=67
//
//  tio-cli tags --create --category "addenda-agents" --value "testagkph"
//  tio-cli tags --delete --category "addenda-agents" --value "testagkph"