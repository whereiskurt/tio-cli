package vulnerability

import (
	"fmt"
	"strconv"
	"sync"

	"github.com/whereiskurt/tio-cli/internal/pkg/tio"
	"github.com/whereiskurt/tio-cli/internal/pkg/tio/dao"
)

type Tags struct {
	Config            *tio.VulnerabilityConfig
	Workers           *sync.WaitGroup
	ConcurrentWorkers int
}

func NewTags(config *tio.VulnerabilityConfig) *Tags {
	s := new(Tags)
	s.Config = config

	s.Workers = new(sync.WaitGroup)
	s.ConcurrentWorkers, _ = strconv.Atoi(config.Base.ConcurrentWorkers)

	return s
}

func (tagsCmd *Tags) Execute() error {
	var trans = dao.NewTranslator(tagsCmd.Config)

	trans.Info("Executing tio.vulnerability.tags.Execute()")

	if tagsCmd.Config.Create == true {
		//TODO: Create code for new Tag
		return nil
	}

	ch := make(chan dao.ScanHistory, 2)

	go trans.GoGetHostDetails(ch, 6)

	for rec := range ch {
		if len(rec.ScanHistoryDetails) == 0 {
			continue
		}
		scan := rec.ScanHistoryDetails[0]
		hosts := scan.Host
		for _, h := range hosts {
			assetUUID := h.Asset.UUID
			tagCategory := tagsCmd.Config.TagCategory
			tagValue := tagsCmd.Config.TagValue

			if tagsCmd.Config.Tag == true {
				trans.TagByAssetUUID(assetUUID, tagCategory, tagValue)
				fmt.Printf("Tagging: Host: %s \t\tUUID:%s \nTags:%+v\nHosts:%+v\n", h.HostId, assetUUID, h.Asset.Tags, h)
				

			} else if	tagsCmd.Config.Untag == true {
				trans.UntagByAssetUUID(assetUUID, tagCategory, tagValue)
				fmt.Printf("Untagging: Host: %s \t\tUUID:%s \nTags:%+v\nHosts:%+v\n", h.HostId, assetUUID, h.Asset.Tags, h)

			} else if	tagsCmd.Config.SearchView == true {

			} else if	tagsCmd.Config.ListView == true {
				fmt.Printf("HostId: %s \t\tUUID:%s \nTags:%+v\nHosts:%+v\n", h.HostId, assetUUID, h.Asset.Tags, h)
			}

		}

	}

	return nil
}

//  tio-cli asset --list --scanId=67
//
//  tio-cli tags --list --scanId=67
//  tio-cli tags --search --category "addenda-agents" --value "testagkph"
//
//  tio-cli tags --tag --category "addenda-agents" --value "testagkph" --scanId=67
//  tio-cli tags --untag --category "addenda-agents" --value "testagkph" --scanId=67
//
//  tio-cli tags --create --category "addenda-agents" --value "testagkph"